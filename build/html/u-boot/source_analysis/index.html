

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.1. source analysis &mdash; ywg_dev_doc 0.1 文档</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="2. kernel note" href="../../kernel/index.html" />
    <link rel="prev" title="1. u-boot dev note" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> ywg_dev_doc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">1. u-boot dev note</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.1. source analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">1.1.1. 目录结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">1.1.2. 重要文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">1.1.3. 生成文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#u-boot">1.1.4. u-boot启动流程</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spl">1.1.4.1. SPL启动流程分析</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.1.4.2. u-boot 启动流程分析</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/index.html">2. kernel note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../driver/index.html">3. linux driver modules note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fs/index.html">4. file system note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">5. application development node</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../work_space/index.html">6. holo work note</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/index.html">7. misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../issues/index.html">8. Issues</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ywg_dev_doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html"><span class="section-number">1. </span>u-boot dev note</a> &raquo;</li>
        
      <li><span class="section-number">1.1. </span>source analysis</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/u-boot/source_analysis/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="source-analysis">
<h1><span class="section-number">1.1. </span>source analysis<a class="headerlink" href="#source-analysis" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2><span class="section-number">1.1.1. </span>目录结构<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>board:      开发板相关目录，平台依赖
arch:       CPU相关目录，平台依赖
include:    头文件目录，开发板的配置文件也在其中，configs存放开发板配置文件
common:     通用多功能函数实现
cmd:        cmd命令实现
drivers:    通用设备驱动程序，包括以太网，flash驱动等
fs:         文件系统支持
lib:        通用库函数实现
net:        网络相关工具
tool:       工具
script:     脚本
</pre></div>
</div>
<p>u-boot目录可分为3类：</p>
<ol class="arabic simple">
<li><p>处理器体系结构或开发板硬件直接相关的</p></li>
<li><p>通用函数或者驱动程序</p></li>
<li><p>u-boot应用程序、工具或者文档</p></li>
</ol>
</div>
<div class="section" id="id2">
<h2><span class="section-number">1.1.2. </span>重要文件<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<ul class="simple">
<li><p>include/configs/holo_ark_v3.h</p></li>
</ul>
<p>开发板配置文件,包含spl loader配置信息，环境变量配置信息，地址配置信息等</p>
<ul class="simple">
<li><p>arch/arm/cpu/armv8/u-boot.lds</p></li>
</ul>
<p>程序链接脚本，定义程序入口entry(_start),并安排各程序段衔接位置，程序首先运行start.s文件。</p>
<ul class="simple">
<li><p>arch/arm/cpu/armv8/start.S</p></li>
</ul>
<p>程序首先运行的文件，程序刚开始运行的汇编代码，完成基本初始化。</p>
<ul class="simple">
<li><p>arch/arm/cpu/armv8/lowlevel_init.S</p></li>
</ul>
<p>内存初始化，clock、SDRAM初始化代码（bootstrap中已完成，不执行）</p>
<ul class="simple">
<li><p>board/holomatic/holo_ark_v3/board.c</p></li>
</ul>
<p>C语言入口start</p>
<ul class="simple">
<li><p>common/main.c</p></li>
</ul>
<p>main_loop()定义于此。</p>
<ul class="simple">
<li><p>arch/arm/lib/interrupts.c</p></li>
</ul>
<p>中断相关函数</p>
<p>main_loop()在没有字符输入的情况下。执行autoboot_command函数，boot kernel</p>
<p>u-boot 实际主要运行的三个位置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_start</span><span class="o">-----&gt;</span><span class="n">start_armboot</span><span class="o">--------&gt;</span><span class="n">main_loop</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2><span class="section-number">1.1.3. </span>生成文件<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>System.map:     uboot映像符号表，它包含了uboot全局变量和函数的地址信息。可供用户查看或由外部程序调试使用
uboot.bin:      uboot映像原始二进制文件。
uboot：         uboot映像elf格式文件。
uboot.srec:     uboot映像的s_record格式。
注：uboot和uboot.srec格式都自带定位信息
tool/mkimge可转换为其他格式印象
</pre></div>
</div>
</div>
<div class="section" id="u-boot">
<h2><span class="section-number">1.1.4. </span>u-boot启动流程<a class="headerlink" href="#u-boot" title="永久链接至标题">¶</a></h2>
<p>嵌入式系统启动的基本流程是这样的：</p>
<p>RoomBoot—&gt;SPL—&gt;u-boot—&gt;linux kernel—&gt;file system——&gt;start application</p>
<ol class="arabic simple">
<li><p>RoomBoot 是固化在芯片内部的代码，负责从各种外(sdcard、mmc、flash、)中加载spl到芯片内部的SRAM</p></li>
<li><p>SPL的主要工作是初始化板载的DDRAM，然后将u-boot搬运到DDRAM中</p></li>
<li><p>u-boot最主要的功能就是加载启动linux kernel</p></li>
</ol>
<p>spl一般是地址无关的，设计成地址无关的主要目的是为了保证SPL被搬运到任何地方都能运行，这样设计是因为我们不知道spl会被放到
哪个地址运行。</p>
<p>位置无关码究其原因，主要是编译生成的汇编代码都是相对地址。</p>
<div class="section" id="spl">
<h3><span class="section-number">1.1.4.1. </span>SPL启动流程分析<a class="headerlink" href="#spl" title="永久链接至标题">¶</a></h3>
<p>spl的入口代码是在arch/arm/lib/vector.S中的 <code class="docutils literal notranslate"><span class="pre">_start</span></code> 函数</p>
<ul class="simple">
<li><p>_start</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">macro</span> <span class="n">ARM_VECTORS</span>
<span class="c1">#ifdef CONFIG_ARCH_K3</span>
    <span class="n">ldr</span>     <span class="n">pc</span><span class="p">,</span> <span class="n">_reset</span>
<span class="c1">#else</span>
    <span class="n">b</span>   <span class="n">reset</span>
<span class="c1">#endif</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_undefined_instruction</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_software_interrupt</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_prefetch_abort</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_data_abort</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_not_used</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_irq</span>
    <span class="n">ldr</span> <span class="n">pc</span><span class="p">,</span> <span class="n">_fiq</span>
    <span class="o">.</span><span class="n">endm</span>

<span class="n">_start</span><span class="p">:</span>
<span class="c1">#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG</span>
   <span class="o">.</span><span class="n">word</span>   <span class="n">CONFIG_SYS_DV_NOR_BOOT_CFG</span>
<span class="c1">#endif</span>
   <span class="n">ARM_VECTORS</span>
<span class="c1">#endif /* !defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK) */</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>_start中直接执行reset</p></li>
<li><p>ldr pc, _xx定义的是中断的处理方式，类似中断向量表</p></li>
</ol>
<p>注：spl阶段是不允许中断的，u-boot可以</p>
<ul class="simple">
<li><p>reset</p></li>
</ul>
<p>代码路径：arch/arm/cpu/armv8/start.S</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reset</span><span class="p">:</span>
    <span class="o">/*</span> <span class="n">Allow</span> <span class="n">the</span> <span class="n">board</span> <span class="n">to</span> <span class="n">save</span> <span class="n">important</span> <span class="n">registers</span> <span class="o">*/</span>
    <span class="n">b</span>       <span class="n">save_boot_params</span>
<span class="o">.</span><span class="n">globl</span>      <span class="n">save_boot_params_ret</span>
<span class="n">save_boot_params_ret</span><span class="p">:</span>

<span class="c1">#if CONFIG_POSITION_INDEPENDENT</span>
    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Fix</span> <span class="o">.</span><span class="n">rela</span><span class="o">.</span><span class="n">dyn</span> <span class="n">relocations</span><span class="o">.</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">U</span><span class="o">-</span><span class="n">Boot</span> <span class="n">to</span> <span class="n">be</span> <span class="n">loaded</span> <span class="n">to</span> <span class="ow">and</span>
     <span class="o">*</span> <span class="n">executed</span> <span class="n">at</span> <span class="n">a</span> <span class="n">different</span> <span class="n">address</span> <span class="n">than</span> <span class="n">it</span> <span class="n">was</span> <span class="n">linked</span> <span class="n">at</span><span class="o">.</span>
     <span class="o">*/</span>
<span class="n">pie_fixup</span><span class="p">:</span>
    <span class="n">adr</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">_start</span>              <span class="o">/*</span> <span class="n">x0</span> <span class="o">&lt;-</span> <span class="n">Runtime</span> <span class="n">value</span> <span class="n">of</span> <span class="n">_start</span> <span class="o">*/</span>
    <span class="n">ldr</span>     <span class="n">x1</span><span class="p">,</span> <span class="n">_TEXT_BASE</span>          <span class="o">/*</span> <span class="n">x1</span> <span class="o">&lt;-</span> <span class="n">Linked</span> <span class="n">value</span> <span class="n">of</span> <span class="n">_start</span> <span class="o">*/</span>
    <span class="n">sub</span>     <span class="n">x9</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span>              <span class="o">/*</span> <span class="n">x9</span> <span class="o">&lt;-</span> <span class="n">Run</span><span class="o">-</span><span class="n">vs</span><span class="o">-</span><span class="n">link</span> <span class="n">offset</span> <span class="o">*/</span>
    <span class="n">adr</span>     <span class="n">x2</span><span class="p">,</span> <span class="n">__rel_dyn_start</span>     <span class="o">/*</span> <span class="n">x2</span> <span class="o">&lt;-</span> <span class="n">Runtime</span> <span class="o">&amp;</span><span class="n">__rel_dyn_start</span> <span class="o">*/</span>
    <span class="n">adr</span>     <span class="n">x3</span><span class="p">,</span> <span class="n">__rel_dyn_end</span>       <span class="o">/*</span> <span class="n">x3</span> <span class="o">&lt;-</span> <span class="n">Runtime</span> <span class="o">&amp;</span><span class="n">__rel_dyn_end</span> <span class="o">*/</span>
<span class="n">pie_fix_loop</span><span class="p">:</span>
    <span class="n">ldp</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x2</span><span class="p">],</span> <span class="c1">#16       /* (x0, x1) &lt;- (Link location, fixup) */</span>
    <span class="n">ldr</span>     <span class="n">x4</span><span class="p">,</span> <span class="p">[</span><span class="n">x2</span><span class="p">],</span> <span class="c1">#8            /* x4 &lt;- addend */</span>
    <span class="n">cmp</span>     <span class="n">w1</span><span class="p">,</span> <span class="c1">#1027               /* relative fixup? */</span>
    <span class="n">bne</span>     <span class="n">pie_skip_reloc</span>
    <span class="o">/*</span> <span class="n">relative</span> <span class="n">fix</span><span class="p">:</span> <span class="n">store</span> <span class="n">addend</span> <span class="n">plus</span> <span class="n">offset</span> <span class="n">at</span> <span class="n">dest</span> <span class="n">location</span> <span class="o">*/</span>
    <span class="n">add</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x9</span>
    <span class="n">add</span>     <span class="n">x4</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x9</span>
    <span class="nb">str</span>     <span class="n">x4</span><span class="p">,</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
<span class="n">pie_skip_reloc</span><span class="p">:</span>
    <span class="n">cmp</span>     <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span>
    <span class="n">b</span><span class="o">.</span><span class="n">lo</span>    <span class="n">pie_fix_loop</span>
<span class="n">pie_fixup_done</span><span class="p">:</span>
<span class="c1">#endif</span>

<span class="c1">#ifdef CONFIG_SYS_RESET_SCTRL</span>
    <span class="n">bl</span> <span class="n">reset_sctrl</span>
<span class="c1">#endif</span>

<span class="c1">#if defined(CONFIG_ARMV8_SPL_EXCEPTION_VECTORS) || !defined(CONFIG_SPL_BUILD)</span>
<span class="o">.</span><span class="n">macro</span>      <span class="n">set_vbar</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">reg</span>
    <span class="n">msr</span>     \<span class="n">regname</span><span class="p">,</span> \<span class="n">reg</span>
<span class="o">.</span><span class="n">endm</span>
    <span class="n">adr</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">vectors</span>
<span class="c1">#else</span>
<span class="o">.</span><span class="n">macro</span>      <span class="n">set_vbar</span><span class="p">,</span> <span class="n">regname</span><span class="p">,</span> <span class="n">reg</span>
<span class="o">.</span><span class="n">endm</span>
<span class="c1">#endif</span>
    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Could</span> <span class="n">be</span> <span class="n">EL3</span><span class="o">/</span><span class="n">EL2</span><span class="o">/</span><span class="n">EL1</span><span class="p">,</span> <span class="n">Initial</span> <span class="n">State</span><span class="p">:</span>
     <span class="o">*</span> <span class="n">Little</span> <span class="n">Endian</span><span class="p">,</span> <span class="n">MMU</span> <span class="n">Disabled</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">dCache</span> <span class="n">Disabled</span>
     <span class="o">*/</span>
    <span class="n">switch_el</span> <span class="n">x1</span><span class="p">,</span> <span class="mi">3</span><span class="n">f</span><span class="p">,</span> <span class="mi">2</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="n">f</span>
<span class="mi">3</span><span class="p">:</span>  <span class="n">set_vbar</span> <span class="n">vbar_el3</span><span class="p">,</span> <span class="n">x0</span>
    <span class="n">mrs</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">scr_el3</span>
    <span class="n">orr</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="c1">#0xf                    /* SCR_EL3.NS|IRQ|FIQ|EA */</span>
    <span class="n">msr</span>     <span class="n">scr_el3</span><span class="p">,</span> <span class="n">x0</span>
    <span class="n">msr</span>     <span class="n">cptr_el3</span><span class="p">,</span> <span class="n">xzr</span>                   <span class="o">/*</span> <span class="n">Enable</span> <span class="n">FP</span><span class="o">/</span><span class="n">SIMD</span> <span class="o">*/</span>
<span class="c1">#ifdef COUNTER_FREQUENCY</span>
    <span class="n">ldr</span>     <span class="n">x0</span><span class="p">,</span> <span class="o">=</span><span class="n">COUNTER_FREQUENCY</span>
    <span class="n">msr</span>     <span class="n">cntfrq_el0</span><span class="p">,</span> <span class="n">x0</span>                  <span class="o">/*</span> <span class="n">Initialize</span> <span class="n">CNTFRQ</span> <span class="o">*/</span>
<span class="c1">#endif</span>
    <span class="n">b</span>       <span class="mi">0</span><span class="n">f</span>
<span class="mi">2</span><span class="p">:</span>  <span class="n">set_vbar</span>        <span class="n">vbar_el2</span><span class="p">,</span> <span class="n">x0</span>
    <span class="n">mov</span>     <span class="n">x0</span><span class="p">,</span> <span class="c1">#0x33ff</span>
    <span class="n">msr</span>     <span class="n">cptr_el2</span><span class="p">,</span> <span class="n">x0</span>                    <span class="o">/*</span> <span class="n">Enable</span> <span class="n">FP</span><span class="o">/</span><span class="n">SIMD</span> <span class="o">*/</span>
    <span class="n">b</span>       <span class="mi">0</span><span class="n">f</span>
<span class="mi">1</span><span class="p">:</span>  <span class="n">set_vbar</span>        <span class="n">vbar_el1</span><span class="p">,</span> <span class="n">x0</span>
    <span class="n">mov</span>     <span class="n">x0</span><span class="p">,</span> <span class="c1">#3 &lt;&lt; 20</span>
    <span class="n">msr</span>     <span class="n">cpacr_el1</span><span class="p">,</span> <span class="n">x0</span>                   <span class="o">/*</span> <span class="n">Enable</span> <span class="n">FP</span><span class="o">/</span><span class="n">SIMD</span> <span class="o">*/</span>
<span class="mi">0</span><span class="p">:</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Enable</span> <span class="n">SMPEN</span> <span class="n">bit</span> <span class="k">for</span> <span class="n">coherency</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">This</span> <span class="n">register</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">architectural</span> <span class="n">but</span> <span class="n">at</span> <span class="n">the</span> <span class="n">moment</span>
     <span class="o">*</span> <span class="n">this</span> <span class="n">bit</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="k">for</span> <span class="n">A53</span><span class="o">/</span><span class="n">A57</span><span class="o">/</span><span class="n">A72</span><span class="o">.</span>
     <span class="o">*/</span>
<span class="c1">#ifdef CONFIG_ARMV8_SET_SMPEN</span>
    <span class="n">switch_el</span> <span class="n">x1</span><span class="p">,</span> <span class="mi">3</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="n">f</span>
<span class="mi">3</span><span class="p">:</span>
    <span class="n">mrs</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">S3_1_c15_c2_1</span>               <span class="o">/*</span> <span class="n">cpuectlr_el1</span> <span class="o">*/</span>
    <span class="n">orr</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="c1">#0x40</span>
    <span class="n">msr</span>     <span class="n">S3_1_c15_c2_1</span><span class="p">,</span> <span class="n">x0</span>
<span class="mi">1</span><span class="p">:</span>
<span class="c1">#endif</span>

    <span class="o">/*</span> <span class="n">Apply</span> <span class="n">ARM</span> <span class="n">core</span> <span class="n">specific</span> <span class="n">erratas</span> <span class="o">*/</span>
    <span class="n">bl</span>      <span class="n">apply_core_errata</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Cache</span><span class="o">/</span><span class="n">BPB</span><span class="o">/</span><span class="n">TLB</span> <span class="n">Invalidate</span>
     <span class="o">*</span> <span class="n">i</span><span class="o">-</span><span class="n">cache</span> <span class="ow">is</span> <span class="n">invalidated</span> <span class="n">before</span> <span class="n">enabled</span> <span class="ow">in</span> <span class="n">icache_enable</span><span class="p">()</span>
     <span class="o">*</span> <span class="n">tlb</span> <span class="ow">is</span> <span class="n">invalidated</span> <span class="n">before</span> <span class="n">mmu</span> <span class="ow">is</span> <span class="n">enabled</span> <span class="ow">in</span> <span class="n">dcache_enable</span><span class="p">()</span>
     <span class="o">*</span> <span class="n">d</span><span class="o">-</span><span class="n">cache</span> <span class="ow">is</span> <span class="n">invalidated</span> <span class="n">before</span> <span class="n">enabled</span> <span class="ow">in</span> <span class="n">dcache_enable</span><span class="p">()</span>
     <span class="o">*/</span>

    <span class="o">/*</span> <span class="n">Processor</span> <span class="n">specific</span> <span class="n">initialization</span> <span class="o">*/</span>
    <span class="n">bl</span>      <span class="n">lowlevel_init</span>

<span class="c1">#if defined(CONFIG_ARMV8_SPIN_TABLE) &amp;&amp; !defined(CONFIG_SPL_BUILD)</span>
    <span class="n">branch_if_master</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">master_cpu</span>
    <span class="n">b</span>       <span class="n">spin_table_secondary_jump</span>
    <span class="o">/*</span> <span class="n">never</span> <span class="k">return</span> <span class="o">*/</span>
<span class="c1">#elif defined(CONFIG_ARMV8_MULTIENTRY)</span>
    <span class="n">branch_if_master</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">master_cpu</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Slave</span> <span class="n">CPUs</span>
     <span class="o">*/</span>
<span class="n">slave_cpu</span><span class="p">:</span>
    <span class="n">wfe</span>
    <span class="n">ldr</span>     <span class="n">x1</span><span class="p">,</span> <span class="o">=</span><span class="n">CPU_RELEASE_ADDR</span>
    <span class="n">ldr</span>     <span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span><span class="p">]</span>
    <span class="n">cbz</span>     <span class="n">x0</span><span class="p">,</span> <span class="n">slave_cpu</span>
    <span class="n">br</span>      <span class="n">x0</span>                      <span class="o">/*</span> <span class="n">branch</span> <span class="n">to</span> <span class="n">the</span> <span class="n">given</span> <span class="n">address</span> <span class="o">*/</span>
<span class="c1">#endif /* CONFIG_ARMV8_MULTIENTRY */</span>
<span class="n">master_cpu</span><span class="p">:</span>
    <span class="n">bl</span>      <span class="n">_main</span>
</pre></div>
</div>
<p>主要设置CPU的工作模式，禁用FIQ，IRQ。然后跳转到 <code class="docutils literal notranslate"><span class="pre">lowlevel_init</span></code> 中，然后跳转到 <code class="docutils literal notranslate"><span class="pre">_main</span></code></p>
<ul class="simple">
<li><p>lowlevel_init</p></li>
</ul>
<p>代码路径：arch/arm/cpu/armv8/lowlevel_init.S</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ENTRY</span><span class="p">(</span><span class="n">lowlevel_init</span><span class="p">)</span>
    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Setup</span> <span class="n">a</span> <span class="n">temporary</span> <span class="n">stack</span><span class="o">.</span> <span class="n">Global</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">available</span> <span class="n">yet</span><span class="o">.</span>
     <span class="o">*/</span>
<span class="c1">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span>
    <span class="n">ldr</span>     <span class="n">w0</span><span class="p">,</span> <span class="o">=</span><span class="n">CONFIG_SPL_STACK</span>
<span class="c1">#else</span>
    <span class="n">ldr</span>     <span class="n">w0</span><span class="p">,</span> <span class="o">=</span><span class="n">CONFIG_SYS_INIT_SP_ADDR</span>
<span class="c1">#endif</span>
    <span class="n">bic</span>     <span class="n">sp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="c1">#0xf    /* 16-byte alignment for ABI compliance */</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Save</span> <span class="n">the</span> <span class="n">old</span> <span class="n">LR</span><span class="p">(</span><span class="n">passed</span> <span class="ow">in</span> <span class="n">x29</span><span class="p">)</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">current</span> <span class="n">LR</span> <span class="n">to</span> <span class="n">stack</span>
     <span class="o">*/</span>
    <span class="n">stp</span>     <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="c1">#-16]!</span>

    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Call</span> <span class="n">the</span> <span class="n">very</span> <span class="n">early</span> <span class="n">init</span> <span class="n">function</span><span class="o">.</span> <span class="n">This</span> <span class="n">should</span> <span class="n">do</span> <span class="n">only</span> <span class="n">the</span>
     <span class="o">*</span> <span class="n">absolute</span> <span class="n">bare</span> <span class="n">minimum</span> <span class="n">to</span> <span class="n">get</span> <span class="n">started</span><span class="o">.</span> <span class="n">It</span> <span class="n">should</span> <span class="ow">not</span><span class="p">:</span>
     <span class="o">*</span>
     <span class="o">*</span> <span class="o">-</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">DRAM</span>
     <span class="o">*</span> <span class="o">-</span> <span class="n">use</span> <span class="n">global_data</span>
     <span class="o">*</span> <span class="o">-</span> <span class="n">clear</span> <span class="n">BSS</span>
     <span class="o">*</span> <span class="o">-</span> <span class="k">try</span> <span class="n">to</span> <span class="n">start</span> <span class="n">a</span> <span class="n">console</span>
     <span class="o">*</span>
     <span class="o">*</span> <span class="n">For</span> <span class="n">boards</span> <span class="k">with</span> <span class="n">SPL</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="n">empty</span> <span class="n">since</span> <span class="n">SPL</span> <span class="n">can</span> <span class="n">do</span> <span class="nb">all</span> <span class="n">of</span>
     <span class="o">*</span> <span class="n">this</span> <span class="n">init</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">SPL</span> <span class="n">board_init_f</span><span class="p">()</span> <span class="n">function</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">called</span>
     <span class="o">*</span> <span class="n">immediately</span> <span class="n">after</span> <span class="n">this</span><span class="o">.</span>
     <span class="o">*/</span>
    <span class="n">bl</span>      <span class="n">s_init</span>
    <span class="n">ldp</span>     <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
    <span class="n">ret</span>
<span class="n">ENDPROC</span><span class="p">(</span><span class="n">lowlevel_init</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>设置栈指针</p></li>
<li><p>确保sp 16字节对齐</p></li>
<li><p>跳转到s_init中</p></li>
</ol>
<ul class="simple">
<li><p>_main</p></li>
</ul>
<p>代码路径： arch/arm/lib/crt0_64.S</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ENTRY(_main)

/*
 * Set up initial C runtime environment and call board_init_f(0).
 */
#if defined(CONFIG_TPL_BUILD) &amp;&amp; defined(CONFIG_TPL_NEEDS_SEPARATE_STACK)
    ldr     x0, =(CONFIG_TPL_STACK)
#elif defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)
    ldr     x0, =(CONFIG_SPL_STACK)
#elif defined(CONFIG_INIT_SP_RELATIVE)
    adr     x0, __bss_start
    add     x0, x0, #CONFIG_SYS_INIT_SP_BSS_OFFSET
#else
    ldr     x0, =(CONFIG_SYS_INIT_SP_ADDR)
#endif
    bic     sp, x0, #0xf    /* 16-byte alignment for ABI compliance */
    mov     x0, sp
    bl      board_init_f_alloc_reserve
    mov     sp, x0
    /* set up gd here, outside any C code */
    mov     x18, x0
    bl      board_init_f_init_reserve

    mov     x0, #0
    bl      board_init_f

#if !defined(CONFIG_SPL_BUILD)
/*
 * Set up intermediate environment (new sp and gd) and call
 * relocate_code(addr_moni). Trick here is that we&#39;ll return
 * &#39;here&#39; but relocated.
 */
    ldr     x0, [x18, #GD_START_ADDR_SP]    /* x0 &lt;- gd-&gt;start_addr_sp */
    bic     sp, x0, #0xf    /* 16-byte alignment for ABI compliance */
    ldr     x18, [x18, #GD_NEW_GD]          /* x18 &lt;- gd-&gt;new_gd */

    adr     lr, relocation_return
#if CONFIG_POSITION_INDEPENDENT
    /* Add in link-vs-runtime offset */
    adr     x0, _start              /* x0 &lt;- Runtime value of _start */
    ldr     x9, _TEXT_BASE          /* x9 &lt;- Linked value of _start */
    sub     x9, x9, x0              /* x9 &lt;- Run-vs-link offset */
    add     lr, lr, x9
#endif
    /* Add in link-vs-relocation offset */
    ldr     x9, [x18, #GD_RELOC_OFF]        /* x9 &lt;- gd-&gt;reloc_off */
    add     lr, lr, x9      /* new return address after relocation */
    ldr     x0, [x18, #GD_RELOCADDR]        /* x0 &lt;- gd-&gt;relocaddr */
    b       relocate_code

relocation_return:

/*
 * Set up final (full) environment
 */
    bl      c_runtime_cpu_setup             /* still call old routine */
#endif /* !CONFIG_SPL_BUILD */
#if !defined(CONFIG_SPL_BUILD) || CONFIG_IS_ENABLED(FRAMEWORK)
#if defined(CONFIG_SPL_BUILD)
    bl      spl_relocate_stack_gd           /* may return NULL */
    /* set up gd here, outside any C code, if new stack is returned */
    cmp     x0, #0
    csel    x18, x0, x18, ne
    /*
     * Perform &#39;sp = (x0 != NULL) ? x0 : sp&#39; while working
     * around the constraint that conditional moves can not
     * have &#39;sp&#39; as an operand
     */
    mov     x1, sp
    cmp     x0, #0
    csel    x0, x0, x1, ne
    mov     sp, x0
#endif

/*
 * Clear BSS section
 */
    ldr     x0, =__bss_start                /* this is auto-relocated! */
    ldr     x1, =__bss_end                  /* this is auto-relocated! */
clear_loop:
    str     xzr, [x0], #8
    cmp     x0, x1
    b.lo    clear_loop

    /* call board_init_r(gd_t *id, ulong dest_addr) */
    mov     x0, x18                         /* gd_t */
    ldr     x1, [x18, #GD_RELOCADDR]        /* dest_addr */
    b       board_init_r                    /* PC relative jump */

    /* NOTREACHED - board_init_r() does not return */
#endif

ENDPROC(_main)
</pre></div>
</div>
<p>_main 所做的工作都是为调用C函数做前期的准备，这个C函数就是 <code class="docutils literal notranslate"><span class="pre">board_init_f</span></code></p>
<ol class="arabic simple">
<li><p>重新对sp赋值，确认是16字节对齐</p></li>
<li><p>board_init_f_alloc_reserve board_init_f_init_reserve C函数在栈顶保留一个global_data的大小，这个global_data是u-boot里面的一个全局数据
很多地方都会用到，俗称gd_t</p></li>
<li><p>跳转到board_init_r</p></li>
</ol>
<ul class="simple">
<li><p>board_init_r</p></li>
</ul>
<p>代码路径： common/spl/spl.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>void board_init_r(gd_t *dummy1, ulong dummy2)
{
    int ret;
    u32 spl_boot_list[] = {
        BOOT_DEVICE_NONE,
        BOOT_DEVICE_NONE,
        BOOT_DEVICE_NONE,
        BOOT_DEVICE_NONE,
        BOOT_DEVICE_NONE,
    };
    struct spl_image_info spl_image;

    debug(&quot;&gt;&gt;&quot; SPL_TPL_PROMPT &quot;board_init_r()\n&quot;);

    spl_set_bd();

#if defined(CONFIG_SYS_SPL_MALLOC_START)
    mem_malloc_init(CONFIG_SYS_SPL_MALLOC_START, CONFIG_SYS_SPL_MALLOC_SIZE);
    gd-&gt;flags |= GD_FLG_FULL_MALLOC_INIT;
#endif

    if (!(gd-&gt;flags &amp; GD_FLG_SPL_INIT)) {
        if (spl_init()) {
            hang();
        }
    }

#if !defined(CONFIG_PPC) &amp;&amp; !defined(CONFIG_ARCH_MX6)
    timer_init();
#endif

    if (CONFIG_IS_ENABLED(BLOBLIST)) {
        ret = bloblist_init();
        if (ret) {
            debug(&quot;%s: Failed to set up bloblist: ret=%d\n&quot;, __func__, ret);
            puts(SPL_TPL_PROMPT &quot;Cannot set up bloblist\n&quot;);
            hang();
        }
    }

    if (CONFIG_IS_ENABLED(HANDOFF)) {
        ret = setup_spl_handoff();
        if (ret) {
            puts(SPL_TPL_PROMPT &quot;Cannot set up SPL handoff\n&quot;);
            hang();
        }
    }

#if CONFIG_IS_ENABLED(BOARD_INIT)
    spl_board_init();
#endif

#if defined(CONFIG_SPL_WATCHDOG_SUPPORT) &amp;&amp; CONFIG_IS_ENABLED(WDT)
    initr_watchdog();
#endif

    if (IS_ENABLED(CONFIG_SPL_OS_BOOT) || CONFIG_IS_ENABLED(HANDOFF)) {
        dram_init_banksize();
    }

    bootcount_inc();

    memset(&amp;spl_image, &#39;\0&#39;, sizeof(spl_image));
#ifdef CONFIG_SYS_SPL_ARGS_ADDR
    spl_image.arg = (void *)CONFIG_SYS_SPL_ARGS_ADDR;
#endif
    spl_image.boot_device = BOOT_DEVICE_NONE;

    board_boot_order(spl_boot_list);

    if (boot_from_devices(&amp;spl_image, spl_boot_list, ARRAY_SIZE(spl_boot_list))) {
        puts(SPL_TPL_PROMPT &quot;failed to boot from all boot devices\n&quot;);
        hang();
    }

    spl_perform_fixups(&amp;spl_image);

    if (CONFIG_IS_ENABLED(HANDOFF)) {
        ret = write_spl_handoff();
        if (ret) {
            printf(SPL_TPL_PROMPT &quot;SPL hand-off write failed (err=%d)\n&quot;, ret);
        }
    }

    if (CONFIG_IS_ENABLED(BLOBLIST)) {
        ret = bloblist_finish();
        if (ret) {
            printf(&quot;Warning: Failed to finish bloblist (ret=%d)\n&quot;, ret);
        }
    }

#ifdef CONFIG_CPU_V7M
    spl_image.entry_point |= 0x1;
#endif

    switch (spl_image.os) {
    case IH_OS_U_BOOT:
        debug(&quot;Jumping to U-Boot\n&quot;);
        break;
#if CONFIG_IS_ENABLED(ATF)
    case IH_OS_ARM_TRUSTED_FIRMWARE:
        debug(&quot;Jumping to U-Boot via ARM Trusted Firmware\n&quot;);
        spl_invoke_atf(&amp;spl_image);
        break;
#endif
#if CONFIG_IS_ENABLED(OPTEE)
    case IH_OS_TEE:
        debug(&quot;Jumping to U-Boot via OP-TEE\n&quot;);
        spl_optee_entry(NULL, NULL, spl_image.fdt_addr, (void *)spl_image.entry_point);
        break;
#endif
#if CONFIG_IS_ENABLED(OPENSBI)
    case IH_OS_OPENSBI:
        debug(&quot;Jumping to U-Boot via RISC-V OpenSBI\n&quot;);
        spl_invoke_opensbi(&amp;spl_image);
        break;
#endif
#ifdef CONFIG_SPL_OS_BOOT
    case IH_OS_LINUX:
        debug(&quot;Jumping to Linux\n&quot;);
        spl_fixup_fdt();
        spl_board_prepare_for_linux();
        jump_to_image_linux(&amp;spl_image);
#endif
    default:
        debug(&quot;Unsupported OS image.. Jumping nevertheless..\n&quot;);
    }
#if CONFIG_VAL(SYS_MALLOC_F_LEN) &amp;&amp; !defined(CONFIG_SYS_SPL_MALLOC_SIZE)
    debug(&quot;SPL malloc() used 0x%lx bytes (%ld KB)\n&quot;, gd-&gt;malloc_ptr, gd-&gt;malloc_ptr / 1024);
#endif
    bootstage_mark_name(spl_phase() == PHASE_TPL ? BOOTSTAGE_ID_END_TPL : BOOTSTAGE_ID_END_SPL, &quot;end &quot; SPL_TPL_NAME);
#ifdef CONFIG_BOOTSTAGE_STASH
    ret = bootstage_stash((void *)CONFIG_BOOTSTAGE_STASH_ADDR, CONFIG_BOOTSTAGE_STASH_SIZE);
    if (ret) {
        debug(&quot;Failed to stash bootstage: err=%d\n&quot;, ret);
    }
#endif

    debug(&quot;loaded - jumping to U-Boot...\n&quot;);
    spl_board_prepare_for_boot();
    jump_to_image_no_args(&amp;spl_image);
}
</pre></div>
</div>
<ol class="arabic simple">
<li><p>mem_malloc_init 进行memory的malloc池初始化，以后调用malloc就在这个池子中分配内存</p></li>
<li><p>spl_init 包括fdt log等前期初始化工作</p></li>
<li><p>timer_init  定时器初始化</p></li>
</ol>
<p>4)  spl_board_init 根据配置选项完成相应的spl阶段外设初始化，包括console i2c misc watchdog
6） 将image从外部设备load到ram中
7)  判断image类型，如果是uboot则break，去运行u-boot。如果是linux则启动linux(说明：spl可以直接启动linux)</p>
<p>至此，SPL结束它的生命，控制权交给uboot或者linux</p>
</div>
<div class="section" id="id4">
<h3><span class="section-number">1.1.4.2. </span>u-boot 启动流程分析<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>从编译系统可知，u-boo.bin的入口代码是arch/arm/lib/vectors.S中的_start函数</p>
<ul class="simple">
<li><p>_start</p></li>
</ul>
<p>代码路径： arch/arm/lib/vectors.S</p>
<p>与SPL的执行流程基本一直，不同的地方是u-boot.bin阶段会负责处理异常中断。_start会跳转到reset</p>
<ul class="simple">
<li><p>reset</p></li>
</ul>
<p>代码路径 arch/arm/cpu/armv8/start.S</p>
<p>与spl的reset执行流程一致。reset会跳转到_main</p>
<ul class="simple">
<li><p>_main</p></li>
</ul>
<p>代码路径： arch/arm/lib/crt0_64.S</p>
<p>前一部分与spl的执行基本一致，board_init_f函数的调用会有不同。两个阶段调用的函数名虽然都是一样的，但实现的文件是不同的。
spl的board_init_f是在arch/arm/lib/spl.c中实现的，而u-boot.bin阶段是在arch/arm/mach-k3/j721e_init.c中实现的，这个不同是由
编译阶段决定的。</p>
<p>第二部分主要的事情是 <code class="docutils literal notranslate"><span class="pre">relocate_code</span></code></p>
<p>u-boot.bin 的链接地址是在编译阶段决定的，假设这个链接地址是0x20000000,SPL在load uboot.bin的时候，需要把它load到这个地址，然后
jump到这个地址运行。</p>
<p>注意：u-boot.bin是地址相关的，只有link address,load address , run address这三者一致才可正常运行。当代码运行到 <code class="docutils literal notranslate"><span class="pre">b</span> <span class="pre">relocate_code</span></code>
这个位置时，代表u-boot.bin已经被加约定地址。</p>
<p>relocate_code意思时把u-boot.bin余下部分的code全部搬运到另外一个地址运行。</p>
<p>relocate_code 代码在arch/arm/lib/relocate_64.S中实现</p>
<p>第三部分是 <code class="docutils literal notranslate"><span class="pre">board_init_r</span></code>,该函数的实现在/common/board_r.c 中。</p>
<ul class="simple">
<li><p>board_init_f</p></li>
</ul>
<p>代码路径： arch/arm/mach-k3/j721e_init.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>void board_init_f(ulong dummy)
{
#if defined(CONFIG_K3_J721E_DDRSS) || defined(CONFIG_K3_LOAD_SYSFW)
    int ret;
    struct udevice *dev;
#endif

    store_boot_index_from_rom();

    ctrl_mmr_unlock();

#ifdef CONFIG_CPU_V7R
    disable_linefill_optimization();
    setup_k3_mpu_regions();
#endif

    spl_early_init();

#ifdef CONFIG_K3_LOAD_SYSFW
    ret = uclass_find_device_by_seq(UCLASS_SERIAL, 0, true, &amp;dev);
    if (!ret) {
        pinctrl_select_state(dev, &quot;default&quot;);
    }

    /*
     * Load, start up, and configure system controller firmware. Provide
     * the U-Boot console init function to the SYSFW post-PM configuration
     * callback hook, effectively switching on (or over) the console
     * output.
     */
    k3_sysfw_loader(k3_mmc_stop_clock, k3_mmc_restart_clock);

    /* Prepare console output */
    preloader_console_init();

    /* Disable ROM configured firewalls right after loading sysfw */
#ifdef CONFIG_TI_SECURE_DEVICE
    remove_fwl_configs(cbass_hc_cfg0_fwls, ARRAY_SIZE(cbass_hc_cfg0_fwls));
    remove_fwl_configs(cbass_hc0_fwls, ARRAY_SIZE(cbass_hc0_fwls));
    remove_fwl_configs(cbass_rc_cfg0_fwls, ARRAY_SIZE(cbass_rc_cfg0_fwls));
    remove_fwl_configs(cbass_rc0_fwls, ARRAY_SIZE(cbass_rc0_fwls));
    remove_fwl_configs(infra_cbass0_fwls, ARRAY_SIZE(infra_cbass0_fwls));
    remove_fwl_configs(mcu_cbass0_fwls, ARRAY_SIZE(mcu_cbass0_fwls));
    remove_fwl_configs(wkup_cbass0_fwls, ARRAY_SIZE(wkup_cbass0_fwls));
#endif
#else
    /* Prepare console output */
    preloader_console_init();
#endif

#if defined(CONFIG_TARGET_J721E_A72_EVM) || defined(CONFIG_TARGET_J721E_R5_EVM)
    /* Perform EEPROM-based board detection */
    do_board_detect();
#endif

#if defined(CONFIG_CPU_V7R) &amp;&amp; defined(CONFIG_K3_AVS0)
    ret = uclass_get_device_by_driver(UCLASS_MISC, DM_GET_DRIVER(k3_avs), &amp;dev);
    if (ret) {
        printf(&quot;AVS init failed: %d\n&quot;, ret);
    }
#endif

#if defined(CONFIG_K3_J721E_DDRSS)
    ret = uclass_get_device(UCLASS_RAM, 0, &amp;dev);
    if (ret) {
        panic(&quot;DRAM init failed: %d\n&quot;, ret);
    }
#endif
}
</pre></div>
</div>
<ol class="arabic simple">
<li><p>设置CPU工作状态</p></li>
<li><p>load u-boot.bin,可以从mmc DFU或者UART获取到</p></li>
<li><p>console初始化</p></li>
</ol>
<ul class="simple">
<li><p>board_init_r</p></li>
</ul>
<p>代码路径： common/board_r.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">board_init_r</span><span class="p">(</span><span class="n">gd_t</span> <span class="o">*</span><span class="n">new_gd</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">dest_addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span>
     <span class="o">*</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">the</span> <span class="n">new</span> <span class="k">global</span> <span class="n">data</span> <span class="n">pointer</span><span class="o">.</span> <span class="n">So</span> <span class="n">far</span> <span class="n">only</span> <span class="n">x86</span> <span class="n">does</span> <span class="n">this</span>
     <span class="o">*</span> <span class="n">here</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">TODO</span><span class="p">(</span><span class="n">sjg</span><span class="nd">@chromium</span><span class="o">.</span><span class="n">org</span><span class="p">):</span> <span class="n">Consider</span> <span class="n">doing</span> <span class="n">this</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">archs</span><span class="p">,</span> <span class="ow">or</span>
     <span class="o">*</span> <span class="n">dropping</span> <span class="n">the</span> <span class="n">new_gd</span> <span class="n">parameter</span><span class="o">.</span>
     <span class="o">*/</span>
<span class="c1">#if CONFIG_IS_ENABLED(X86_64)</span>
    <span class="n">arch_setup_gd</span><span class="p">(</span><span class="n">new_gd</span><span class="p">);</span>
<span class="c1">#endif</span>

<span class="c1">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
<span class="c1">#endif</span>

<span class="c1">#if !defined(CONFIG_X86) &amp;&amp; !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_ARM64)</span>
    <span class="n">gd</span> <span class="o">=</span> <span class="n">new_gd</span><span class="p">;</span>
<span class="c1">#endif</span>
    <span class="n">gd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GD_FLG_LOG_READY</span><span class="p">;</span>

<span class="c1">#ifdef CONFIG_NEEDS_MANUAL_RELOC</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init_sequence_r</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">init_sequence_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gd</span><span class="o">-&gt;</span><span class="n">reloc_off</span><span class="p">;</span>
<span class="c1">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">initcall_run_list</span><span class="p">(</span><span class="n">init_sequence_r</span><span class="p">))</span>
        <span class="n">hang</span><span class="p">();</span>

    <span class="o">/*</span> <span class="n">NOTREACHED</span> <span class="o">-</span> <span class="n">run_main_loop</span><span class="p">()</span> <span class="n">does</span> <span class="ow">not</span> <span class="k">return</span> <span class="o">*/</span>
    <span class="n">hang</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>board_init_r中一个重要的函数是 <code class="docutils literal notranslate"><span class="pre">initcall_run_list(init_sequrnce_r)</span></code> ,此函数会顺序调用 <code class="docutils literal notranslate"><span class="pre">init_sequence_r</span></code> 中的
函数列表。如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static init_fnc_t init_sequence_r[] = {
    initr_trace,
    initr_reloc,
    /* TODO: could x86/PPC have this also perhaps? */
#ifdef CONFIG_ARM
    initr_caches,
    /* Note: For Freescale LS2 SoCs, new MMU table is created in DDR.
     *       A temporary mapping of IFC high region is since removed,
     *       so environmental variables in NOR flash is not available
     *       until board_init() is called below to remap IFC to high
     *       region.
     */
#endif
    initr_reloc_global_data,
#if defined(CONFIG_SYS_INIT_RAM_LOCK) &amp;&amp; defined(CONFIG_E500)
    initr_unlock_ram_in_cache,
#endif
    initr_barrier,
    initr_malloc,
    log_init,
    initr_bootstage,        /* Needs malloc() but has its own timer */
    initr_console_record,
#ifdef CONFIG_SYS_NONCACHED_MEMORY
    initr_noncached,
#endif
#ifdef CONFIG_OF_LIVE
    initr_of_live,
#endif
#ifdef CONFIG_DM
    initr_dm,
#endif
#if defined(CONFIG_ARM) || defined(CONFIG_NDS32) || defined(CONFIG_RISCV) || \
    defined(CONFIG_SANDBOX)
    board_init,     /* Setup chipselects */
#endif
    /*
     * TODO: printing of the clock inforamtion of the board is now
     * implemented as part of bdinfo command. Currently only support for
     * davinci SOC&#39;s is added. Remove this check once all the board
     * implement this.
     */
#ifdef CONFIG_CLOCKS
    set_cpu_clk_info, /* Setup clock information */
#endif
#ifdef CONFIG_EFI_LOADER
    efi_memory_init,
#endif
    initr_binman,
#ifdef CONFIG_FSP_VERSION2
    arch_fsp_init_r,
#endif
    initr_dm_devices,
    stdio_init_tables,
    initr_serial,
    initr_announce,
#if CONFIG_IS_ENABLED(WDT)
    initr_watchdog,
#endif
    INIT_FUNC_WATCHDOG_RESET
#ifdef CONFIG_NEEDS_MANUAL_RELOC
    initr_manual_reloc_cmdtable,
#endif
#if defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_MIPS)
    initr_trap,
#endif
#ifdef CONFIG_ADDR_MAP
    initr_addr_map,
#endif
#if defined(CONFIG_BOARD_EARLY_INIT_R)
    board_early_init_r,
#endif
    INIT_FUNC_WATCHDOG_RESET
#ifdef CONFIG_POST
    initr_post_backlog,
#endif
    INIT_FUNC_WATCHDOG_RESET
#if defined(CONFIG_PCI) &amp;&amp; defined(CONFIG_SYS_EARLY_PCI_INIT)
    /*
     * Do early PCI configuration _before_ the flash gets initialised,
     * because PCU resources are crucial for flash access on some boards.
     */
    initr_pci,
#endif
#ifdef CONFIG_ARCH_EARLY_INIT_R
    arch_early_init_r,
#endif
    power_init_board,
#ifdef CONFIG_MTD_NOR_FLASH
    initr_flash,
#endif
    INIT_FUNC_WATCHDOG_RESET
#if defined(CONFIG_PPC) || defined(CONFIG_M68K) || defined(CONFIG_X86)
    /* initialize higher level parts of CPU like time base and timers */
    cpu_init_r,
#endif
#ifdef CONFIG_CMD_NAND
    initr_nand,
#endif
#ifdef CONFIG_CMD_ONENAND
    initr_onenand,
#endif
#ifdef CONFIG_MMC
    initr_mmc,
#endif
    initr_env,
#ifdef CONFIG_SYS_BOOTPARAMS_LEN
    initr_malloc_bootparams,
#endif
    INIT_FUNC_WATCHDOG_RESET
    initr_secondary_cpu,
#if defined(CONFIG_ID_EEPROM) || defined(CONFIG_SYS_I2C_MAC_OFFSET)
    mac_read_from_eeprom,
#endif
    INIT_FUNC_WATCHDOG_RESET
#if defined(CONFIG_PCI) &amp;&amp; !defined(CONFIG_SYS_EARLY_PCI_INIT)
    /*
     * Do pci configuration
     */
    initr_pci,
#endif
    stdio_add_devices,
    initr_jumptable,
#ifdef CONFIG_API
    initr_api,
#endif
    console_init_r,         /* fully init console as a device */
#ifdef CONFIG_DISPLAY_BOARDINFO_LATE
    console_announce_r,
    show_board_info,
#endif
#ifdef CONFIG_ARCH_MISC_INIT
    arch_misc_init,         /* miscellaneous arch-dependent init */
#endif
#ifdef CONFIG_MISC_INIT_R
    misc_init_r,            /* miscellaneous platform-dependent init */
#endif
    INIT_FUNC_WATCHDOG_RESET
#ifdef CONFIG_CMD_KGDB
    initr_kgdb,
#endif
    interrupt_init,
#ifdef CONFIG_ARM
    initr_enable_interrupts,
#endif
#if defined(CONFIG_MICROBLAZE) || defined(CONFIG_M68K)
    timer_init,             /* initialize timer */
#endif
#if defined(CONFIG_LED_STATUS)
    initr_status_led,
#endif
    /* PPC has a udelay(20) here dating from 2002. Why? */
#ifdef CONFIG_CMD_NET
    initr_ethaddr,
#endif
#if defined(CONFIG_GPIO_HOG)
    gpio_hog_probe_all,
#endif
#ifdef CONFIG_BOARD_LATE_INIT
    board_late_init,
#endif
#if defined(CONFIG_SCSI) &amp;&amp; !defined(CONFIG_DM_SCSI)
    INIT_FUNC_WATCHDOG_RESET
    initr_scsi,
#endif
#ifdef CONFIG_BITBANGMII
    initr_bbmii,
#endif
#ifdef CONFIG_CMD_NET
    INIT_FUNC_WATCHDOG_RESET
    initr_net,
#endif
#ifdef CONFIG_POST
    initr_post,
#endif
#if defined(CONFIG_IDE) &amp;&amp; !defined(CONFIG_BLK)
    initr_ide,
#endif
#ifdef CONFIG_LAST_STAGE_INIT
    INIT_FUNC_WATCHDOG_RESET
    /*
     * Some parts can be only initialized if all others (like
     * Interrupts) are up and running (i.e. the PC-style ISA
     * keyboard).
     */
    last_stage_init,
#endif
#ifdef CONFIG_CMD_BEDBUG
    INIT_FUNC_WATCHDOG_RESET
    initr_bedbug,
#endif
#if defined(CONFIG_PRAM)
    initr_mem,
#endif
#if defined(CONFIG_M68K) &amp;&amp; defined(CONFIG_BLOCK_CACHE)
    blkcache_init,
#endif
    run_main_loop,
};
</pre></div>
</div>
<p>此函数列表囊括了C语言实现的u-boot 几乎所有功能。通过函数名可大概了解到实现的功能</p>
<p>最后一个函数run_main_loop会跳转到main_loop中执行。</p>
<ul class="simple">
<li><p>main_loop</p></li>
</ul>
<p>代码路径： common/main.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">We</span> <span class="n">come</span> <span class="n">here</span> <span class="n">after</span> <span class="n">U</span><span class="o">-</span><span class="n">Boot</span> <span class="ow">is</span> <span class="n">initialised</span> <span class="ow">and</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">process</span> <span class="n">commands</span> <span class="o">*/</span>
<span class="n">void</span> <span class="n">main_loop</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

    <span class="n">bootstage_mark_name</span><span class="p">(</span><span class="n">BOOTSTAGE_ID_MAIN_LOOP</span><span class="p">,</span> <span class="s2">&quot;main_loop&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_VERSION_VARIABLE</span><span class="p">))</span>
        <span class="n">env_set</span><span class="p">(</span><span class="s2">&quot;ver&quot;</span><span class="p">,</span> <span class="n">version_string</span><span class="p">);</span>  <span class="o">/*</span> <span class="nb">set</span> <span class="n">version</span> <span class="n">variable</span> <span class="o">*/</span>

    <span class="n">cli_init</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_USE_PREBOOT</span><span class="p">))</span>
        <span class="n">run_preboot_environment_command</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ENABLED</span><span class="p">(</span><span class="n">CONFIG_UPDATE_TFTP</span><span class="p">))</span>
        <span class="n">update_tftp</span><span class="p">(</span><span class="mi">0</span><span class="n">UL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">bootdelay_process</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cli_process_fdt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">))</span>
        <span class="n">cli_secure_boot_cmd</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

    <span class="n">autoboot_command</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

    <span class="n">cli_loop</span><span class="p">();</span>
    <span class="n">panic</span><span class="p">(</span><span class="s2">&quot;No CLI available&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>bootstage_mark_name设置当前状态为main_loop</p></li>
<li><p>设置环境变量env</p></li>
<li><p>run_preboot_environment_command 运行环境变量preboot所定义的命令</p></li>
<li><p>如果定义了CONFIG_UPDATE_TFTP则通过tftp下在filename到某个地址然后将其烧录到flash中</p></li>
<li><p>bootdelay_process 从环境变量bootdelay获取需要等待多少时间，超时时间内没有字符键入则
从环境变量bootcmd中获取对应的命令然后执行</p></li>
</ol>
<p>至此u-boot结束它的生命周期，控制权交由kernel</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../kernel/index.html" class="btn btn-neutral float-right" title="2. kernel note" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../index.html" class="btn btn-neutral float-left" title="1. u-boot dev note" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 版权所有 2020, yinwg

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>