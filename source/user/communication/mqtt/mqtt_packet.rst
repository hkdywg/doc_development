MQTT报文
===========


MQTT控制报文格式
-------------------

MQTT协议通过交换预定义的MQTT控制报文来通信，MQTT控制报文由三部分组成

- Fixed Header: 固定报头，所有控制报文都包含

- Variable Header: 可变报头，部分控制报文包含

- Payload: 有效载荷，部分控制报文包含


固定报头
^^^^^^^^^^


- 固定报头格式

===========  ==== ==== ==== ==== ==== ==== ==== ====
 比特位　      7    6    5    4   3    2     1   0
-----------  ---- ---- ---- ---- ---- ---- ---- ----
 byte 1        MQTT控制报文类型 　标志位
-----------  ------------------- -------------------
 btye 2..      剩余长度
===========  =======================================


- MQTT控制报文类型

=================   =========   ================    ==========================================================================================
 名字　　               值　     报文流动方向　                 描述
-----------------   ---------   ----------------    ------------------------------------------------------------------------------------------
 Reserved               0           禁止
 CONNECT                1           C------>S         客户端请求连接服务端
 CONACK                 2           S------>C         连接报文确认
 PUBLISH                3           C<----->S         发布消息
 PUBACK                 4           C<----->S         QOS 1消息发布收到确认
 PUBREC                 5           C<----->S         发布收到(保证交付第一步)
 PUREL                  6           C<----->S         发布释放(保证交付第二步)
 PUBCOMP                7           C<----->S         QOS 2消息发布完成(保证交付第三步)
 SUBSCRIBE              8           C------>S         客户端订阅请求
 SUBACK                 9           S------>C         订阅请求报文确认
 UNSUBSCRIBE            10          C------>S         客户端取消订阅请求
 UNSUBACK               11          S------>C         取消订阅报文确认
 PINGREQ                12          C------>S         心跳请求
 PINGRESP               13          S------>C         心跳响应
 DISCONNECT             14          C<----->S         断开连接通知
 AUTH                   15          C<----->S         认证信息交换
=================   =========   ================    ==========================================================================================

- 标志位

================ ============================= ======= ======= ======= ======== 
 控制报文　         固定报头标志　              b3      b2      b1       b0
---------------- ----------------------------- ------- ------- ------- --------
 PUBLISH           used in mqtt v3.1.1          dup       qos           retain
---------------- ----------------------------- ------- --------------- --------
 PUBREL           Reserved                      0       0       1       0
 SUBSCRIBE        Reserved                      0       0       1       0
 UNSUBSCRIBE      Reserved                      0       0       1       0
================ ============================= ======= ======= ======= ======== 

.. note::
    1. dup:控制报文重发的标志

    2. qos:PUBLISH报文的服务质量等级

    3. retain:PUBLISH报文保留标志,用于保留消息发送


- 剩余长度: 从第二字节开始，是一个变长字节的整数，用于表示当前控制报文剩余部分的字节数，包含可变报头和负载的数据

可变报头(Variable Header)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

可变报头部分包含了2个字节的报文标识符字段

=================== ====================================
 控制类型　　           是否需要标识符字段
------------------- ------------------------------------
 CONNECT                否
 CONNACK                否
 PUBLISH                是(如果QOS>0)
 PUBACK                 是
 PUBREC                 是
 PUBREL                 是
 PUBCOMP                是
 SUBSCRIBE              是
 SUBACK                 是
 UNSUBSCRIBE            是
 UNSUBACK               是
 PINGREQ                否
 PINGRESP               否
 DISCONNECT             否
 AUTH                   否
=================== ====================================

::
    
    Client                                      Server
    PUBLISH Packet Identifier = 0x1234  ----->
          <----- PUBLISH Packet Identifier = 0x1234
    PUBACK Packet Identifier = 0x1234   ----->
          <----- PUBACK Packet Identifier = 0x1234


Payload
^^^^^^^^^^^

=================== ====================================
 控制类型　　           是否需要payload
------------------- ------------------------------------
 CONNECT                是
 CONNACK                否
 PUBLISH                可选
 PUBACK                 否
 PUBREC                 否
 PUBREL                 否
 PUBCOMP                否
 SUBSCRIBE              是
 SUBACK                 是
 UNSUBSCRIBE            是
 UNSUBACK               否
 PINGREQ                否
 PINGRESP               否
 DISCONNECT             否
=================== ====================================


MQTT控制报文
-------------------

CONNECT - 客户端请求连接服务器
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

每个客户端只能发送一次CONNECT包，服务端会把此客户端再次发送的CONNECT包当作违反协议处理，并断开与此客户端的连接


- 固定报头: CONNECT包头

- 可变报头: 协议名字，协议等级，连接标识，保持连接

.. image::
    res/connect_options.png

- 载荷: CONNECT包的载荷可以包含一个或多个带有长度前缀的字段，这取决于可变包头的标识，这些字段如果存在，必须按照这样的顺序(1.客户端唯一标识 2.Will Topic 
  3.Will Message 4.User Name 5.Password)
    






